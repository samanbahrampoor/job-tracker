<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Job Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- If you have a separate style.css in the repo, keep this link -->
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Minimal sensible defaults (safe if style.css missing) */
    :root { --card:#f8f9fb; --muted:#6b7280; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; margin: 24px; }
    h1 { margin: 0 0 12px; font-size: 22px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 12px; border: 0; border-radius: 8px; background: #111827; color: white; cursor: pointer; }
    button[disabled] { opacity: .6; cursor: default; }
    #status { color: var(--muted); font-size: 14px; }
    #sync { position: fixed; right: 12px; bottom: 12px; background: #111827; color:#fff; padding: 6px 10px; border-radius: 999px; font-size: 12px; display:none; }
    .group { margin: 18px 0 26px; }
    .group h2 { font-size: 18px; margin: 16px 0 6px; }
    .group h3 { font-size: 14px; margin: 10px 0 8px; color: var(--muted); }
    .job { background: var(--card); border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; margin: 8px 0; }
    .job .title { font-weight: 600; }
    .meta { color: var(--muted); font-size: 12px; margin-top: 4px; display:flex; gap:10px; flex-wrap:wrap; }
    .meta a { color: inherit; text-decoration: underline; }
    .applied { margin-top: 8px; }
  </style>
</head>
<body>
  <h1>Job Tracker</h1>

  <div class="row" style="margin-bottom:12px">
    <button id="signin">Sign in with GitHub</button>
    <div id="status">Checking session…</div>
  </div>

  <div id="jobs"></div>

  <div id="sync">Sync: error</div>

  <script>
    // ====== CONFIG ======
    const WORKER_BASE = "https://job-tracker-oauth.saman-bahrampoor.workers.dev";

    // ====== STATE ======
    let currentUser = null;
    let appliedMap = new Map();

    // ====== HELPERS ======
    function showSync(msg, isError = false) {
      const el = document.getElementById("sync");
      el.textContent = `Sync: ${msg}`;
      el.style.background = isError ? "#b91c1c" : "#065f46";
      el.style.display = "inline-block";
      clearTimeout(el._t);
      el._t = setTimeout(() => (el.style.display = "none"), 2200);
    }

    function jobId(job) {
      // Prefer a stable id in jobs.json; else derive one best-effort from fields.
      if (job.id) return String(job.id);
      const raw = `${job.company || ""}|${job.title || ""}|${job.country || ""}|${job.city || ""}|${job.url || ""}`;
      // Cheap, URL-safe base64
      return btoa(unescape(encodeURIComponent(raw)));
    }

    async function safeFetch(url, opts = {}) {
      const res = await fetch(url, { credentials: "include", ...opts });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res;
    }

    // ====== AUTH ======
    async function getSession() {
      try {
        const res = await safeFetch(`${WORKER_BASE}/api/me`);
        const { user } = await res.json();
        currentUser = user;
        document.getElementById("status").textContent = `Signed in as ${user.email || user.id}`;
        document.getElementById("signin").disabled = true;
      } catch {
        currentUser = null;
        document.getElementById("status").textContent = "Not signed in";
        document.getElementById("signin").disabled = false;
      }
    }

    // ====== DATA LOAD ======
    async function loadApplied() {
      if (!currentUser) return;
      try {
        const res = await safeFetch(`${WORKER_BASE}/api/applications`);
        const { items } = await res.json();
        appliedMap = new Map(items.map(x => [x.job_id, !!x.applied]));
      } catch (e) {
        showSync("error", true);
      }
    }

    async function toggleApplied(jid, applied) {
      try {
        await safeFetch(`${WORKER_BASE}/api/applications/${encodeURIComponent(jid)}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ applied })
        });
        appliedMap.set(jid, applied);
        showSync("ok", false);
      } catch (e) {
        showSync("error", true);
      }
    }

    // ====== RENDER ======
    async function render() {
      const container = document.getElementById("jobs");
      container.innerHTML = "";
      const resp = await fetch("jobs.json");
      const jobs = await resp.json();

      // Group by company → location
      const groups = new Map();
      for (const job of jobs) {
        const company = job.company || "Unknown Company";
        const location = `${job.country || "Unknown Country"} / ${job.city || "Unknown City"}`;
        if (!groups.has(company)) groups.set(company, new Map());
        const byLoc = groups.get(company);
        if (!byLoc.has(location)) byLoc.set(location, []);
        byLoc.get(location).push(job);
      }

      for (const [company, byLoc] of groups) {
        const g = document.createElement("div");
        g.className = "group";
        const h2 = document.createElement("h2");
        h2.textContent = company;
        g.appendChild(h2);

        for (const [loc, arr] of byLoc) {
          const h3 = document.createElement("h3");
          h3.textContent = loc;
          g.appendChild(h3);

          for (const job of arr) {
            const jid = jobId(job);

            const card = document.createElement("div");
            card.className = "job";

            const title = document.createElement("div");
            title.className = "title";
            title.textContent = job.title || "Untitled Job";
            card.appendChild(title);

            const meta = document.createElement("div");
            meta.className = "meta";
            if (job.url) {
              const link = document.createElement("a");
              link.href = job.url;
              link.target = "_blank";
              link.rel = "noopener noreferrer";
              link.textContent = job.url;
              meta.appendChild(link);
            }
            if (job.posted_date) {
              const span = document.createElement("span");
              span.textContent = `Posted: ${job.posted_date}`;
              meta.appendChild(span);
            }
            card.appendChild(meta);

            const label = document.createElement("label");
            label.className = "applied";
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.checked = appliedMap.get(jid) || false;
            cb.addEventListener("change", () => {
              if (!currentUser) {
                alert("Please sign in first.");
                cb.checked = false;
                return;
              }
              toggleApplied(jid, cb.checked);
            });
            label.appendChild(cb);
            label.appendChild(document.createTextNode(" Applied"));
            card.appendChild(label);

            g.appendChild(card);
          }
        }

        container.appendChild(g);
      }
    }

    // ====== INIT ======
    document.getElementById("signin").addEventListener("click", () => {
      // Start OAuth via Worker
      window.location.href = `${WORKER_BASE}/auth/github/start`;
    });

    (async () => {
      await getSession();          // populates currentUser
      if (currentUser) await loadApplied();
      await render();
    })();
  </script>
</body>
</html>
