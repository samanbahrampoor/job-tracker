<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Jobs Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    .filters { margin: 20px 0; text-align: center; }
    .job { background: #fff; margin: 10px 0; padding: 15px; border-radius: 8px;
           box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .company { font-weight: bold; font-size: 18px; margin-top: 20px; }
    .title { font-size: 16px; font-weight: bold; }
    .location { color: #555; }
    .applied { margin-left: 10px; }
  </style>
</head>
<body>
  <h1>Jobs Dashboard</h1>
  <button id="login">Sign in with GitHub</button>
  <div class="filters" style="display:none">
    <label><input type="checkbox" id="filter-applied"> Show only applied</label>
    <select id="filter-location">
      <option value="">All locations</option>
    </select>
  </div>
  <div id="jobs"></div>

  <script>
    const WORKER_BASE = "https://job-tracker-oauth.saman-bahrampoor.workers.dev";
	const APP_URL = "https://samanbahrampoor.github.io/job-tracker/jobs.html"; // exact file

	document.getElementById("loginBtn").addEventListener("click", () => {
    location.href = WORKER_BASE + "/oauth/login?redirect=" + encodeURIComponent(APP_URL);});
    let token = null;
    // Grab token from URL fragment
    if (location.hash.startsWith("#token=")) {
      token = location.hash.slice(7);
      sessionStorage.setItem("session-token", token);
      history.replaceState(null, "", location.pathname);
    } else {
      token = sessionStorage.getItem("session-token");
    }

    async function getSession() {
      if (!token) return null;
      const res = await fetch(WORKER_BASE + "/api/session", {
        headers: { Authorization: "Bearer " + token }
      });
      if (!res.ok) return null;
      return res.json();
    }

    async function getJobs() {
      const res = await fetch(WORKER_BASE + "/api/jobs", {
        headers: { Authorization: "Bearer " + token }
      });
      return res.json();
    }

    function renderJobs(jobs) {
      const container = document.getElementById("jobs");
      container.innerHTML = "";
      let locs = new Set();
      jobs.forEach(job => {
        const div = document.createElement("div");
        div.className = "job";
        div.dataset.location = job.Country + ", " + job.City;
        div.dataset.id = job.JobID;
        div.innerHTML = `
          <div class="title"><a href="${job.Link}" target="_blank">${job.Title}</a></div>
          <div class="location">${job.Country}, ${job.City}</div>
          <label class="applied">
            <input type="checkbox" class="apply-box" data-id="${job.JobID}"> Applied
          </label>
        `;
        container.appendChild(div);
        locs.add(div.dataset.location);
      });

      // restore applied state
      document.querySelectorAll(".apply-box").forEach(box => {
        const id = box.dataset.id;
        box.checked = localStorage.getItem("applied-" + id) === "true";
        box.addEventListener("change", () => {
          localStorage.setItem("applied-" + id, box.checked);
        });
      });

      // fill location filter
      const sel = document.getElementById("filter-location");
      sel.innerHTML = "<option value=''>All locations</option>";
      [...locs].sort().forEach(loc => {
        const opt = document.createElement("option");
        opt.value = loc; opt.textContent = loc;
        sel.appendChild(opt);
      });
    }

    function applyFilters() {
      const appliedOnly = document.getElementById("filter-applied").checked;
      const loc = document.getElementById("filter-location").value;
      document.querySelectorAll(".job").forEach(job => {
        const checked = job.querySelector(".apply-box").checked;
        let visible = true;
        if (appliedOnly && !checked) visible = false;
        if (loc && job.dataset.location !== loc) visible = false;
        job.style.display = visible ? "" : "none";
      });
    }

    document.getElementById("filter-applied").addEventListener("change", applyFilters);
    document.getElementById("filter-location").addEventListener("change", applyFilters);

    document.getElementById("login").addEventListener("click", () => {
      location.href = WORKER_BASE + "/oauth/login?redirect=" + encodeURIComponent(location.href);
    });

    (async () => {
      const session = await getSession();
      if (!session) return;
      document.getElementById("login").style.display = "none";
      document.querySelector(".filters").style.display = "";
      const jobs = await getJobs();
      renderJobs(jobs);
    })();
  </script>
</body>
</html>
