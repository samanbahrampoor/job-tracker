<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Job Tracker</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header id="header">
    <h1>Job Tracker</h1>
    <div id="auth">
      <button id="signin-btn" style="display:none;">Sign in with GitHub</button>
      <span id="signedin-wrap" style="display:none;">
        <span id="signedin-as"></span>
        <button id="signout-btn">Sign out</button>
      </span>
    </div>
  </header>

  <div id="messages">
    <div id="error" role="alert" style="display:none;"></div>
    <div id="info" style="display:none;"></div>
    <div id="save-indicator" aria-live="polite"></div>
  </div>

  <main id="content">
    <section id="jobs">
      <div id="loading">Loading jobs…</div>
    </section>
  </main>

  <script>
  // ===== Config =====
  const API_BASE = "https://job-tracker-oauth.saman-bahrampoor.workers.dev";
  const JOBS_JSON_URL = "jobs.json";

  // ===== State =====
  let jobs = [];
  let appliedById = {};
  let saveTimer = null;

  // ===== UI refs =====
  const $signinBtn = document.getElementById("signin-btn");
  const $signoutBtn = document.getElementById("signout-btn");
  const $signedInWrap = document.getElementById("signedin-wrap");
  const $signedInAs = document.getElementById("signedin-as");
  const $error = document.getElementById("error");
  const $info = document.getElementById("info");
  const $saveIndicator = document.getElementById("save-indicator");
  const $jobs = document.getElementById("jobs");

  // ===== Helpers =====
  function showError(msg){ $error.textContent = msg; $error.style.display = "block"; }
  function clearError(){ $error.textContent=""; $error.style.display = "none"; }
  function showInfo(msg){ $info.textContent = msg; $info.style.display = "block"; }
  function clearInfo(){ $info.textContent=""; $info.style.display = "none"; }
  function setSaving(state){
    if(state==="saving") $saveIndicator.textContent="Saving…";
    else if(state==="saved") $saveIndicator.textContent="Saved.";
    else $saveIndicator.textContent="";
  }

  // small deterministic hash for IDs
  function hashId(str){
    let h=2166136261>>>0;
    for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619); }
    h+=h<<13; h^=h>>>7; h+=h<<3; h^=h>>>17; h+=h<<5;
    return (h>>>0).toString(36);
  }
  function computeJobId(j){
    if (j.id) return String(j.id);
    const c=(j.company||j.Company||"").trim();
    const t=(j.title||j.Title||"").trim();
    const ci=(j.city||j.City||"").trim();
    const co=(j.country||j.Country||"").trim();
    const u=(j.url||j.URL||j.link||j.Link||"").trim();
    return hashId(`${c}|${t}|${ci}|${co}|${u}`.toLowerCase());
  }
  function jobTitle(j){ return (j.title||j.Title||"").trim(); }
  function jobCompany(j){ return (j.company||j.Company||"").trim(); }
  function jobCountryCity(j){
    const co=(j.country||j.Country||"").trim();
    const ci=(j.city||j.City||"").trim();
    return [co,ci].filter(Boolean).join(" / ");
  }
  function jobUrl(j){ return (j.url||j.URL||j.link||j.Link||"#").trim(); }

  function groupByCompanyThenLocation(list){
    const g={};
    for(const j of list){
      const comp = jobCompany(j) || "Unknown";
      const loc = jobCountryCity(j) || "Unknown";
      g[comp] ??= {};
      g[comp][loc] ??= [];
      g[comp][loc].push(j);
    }
    return g;
  }

  // ===== Render =====
  function renderJobs(){
    $jobs.innerHTML = "";
    const grouped = groupByCompanyThenLocation(jobs);

    const container = document.createElement("div");
    container.id = "jobs-container";

    Object.keys(grouped).sort((a,b)=>a.localeCompare(b)).forEach(company=>{
      const section = document.createElement("section");
      section.className = "company-group";
      const h2 = document.createElement("h2");
      h2.textContent = company;
      section.appendChild(h2);

      const locs = grouped[company];
      Object.keys(locs).sort((a,b)=>a.localeCompare(b)).forEach(loc=>{
        const locDiv = document.createElement("div");
        locDiv.className="location-group";

        const h3=document.createElement("h3"); h3.textContent=loc; locDiv.appendChild(h3);
        const ul=document.createElement("ul"); ul.className="job-list";

        locs[loc].slice().sort((a,b)=>jobTitle(a).localeCompare(jobTitle(b))).forEach(j=>{
          const id = computeJobId(j);

          const li=document.createElement("li"); li.className="job";
          const a=document.createElement("a"); a.href=jobUrl(j); a.target="_blank"; a.rel="noopener noreferrer"; a.textContent=jobTitle(j);
          const label=document.createElement("label"); label.className="applied-label";
          const cb=document.createElement("input"); cb.type="checkbox"; cb.className="applied-toggle"; cb.setAttribute("data-job-id", id); cb.checked=!!appliedById[id];
          const small=document.createElement("small"); small.textContent=" Applied";

          label.appendChild(cb); label.appendChild(small);
          li.appendChild(a); li.appendChild(label);
          ul.appendChild(li);
        });

        locDiv.appendChild(ul);
        section.appendChild(locDiv);
      });

      container.appendChild(section);
    });

    $jobs.appendChild(container);
  }

  // ===== Persistence =====
  async function loadStatus(){
    const res = await fetch(`${API_BASE}/api/status`, { method:"GET", credentials:"include" });
    if (res.status === 401) {
      appliedById = {};
      $signinBtn.style.display = "";
      $signedInWrap.style.display = "none";
      showInfo("Sign in to save and sync your Applied status across devices.");
      return false;
    }
    if (!res.ok) throw new Error(`Status load failed: ${res.status}`);
    appliedById = await res.json();
    $signinBtn.style.display = "none";
    $signedInWrap.style.display = "";
    clearInfo();
    // Show whoami if you like
    fetch(`${API_BASE}/api/whoami`, { credentials: "include" }).then(r=>r.json()).then(({user})=>{
      if (user?.login) $signedInAs.textContent = `Signed in as ${user.login}`;
    }).catch(()=>{});
    return true;
  }

  function scheduleSave(){
    clearTimeout(saveTimer);
    setSaving("saving");
    saveTimer = setTimeout(async ()=>{
      await fetch(`${API_BASE}/api/status`, {
        method:"PUT",
        credentials:"include",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(appliedById)
      });
      setSaving("saved");
    }, 300);
  }

  function wireCheckboxSaves(){
    document.addEventListener("change", (e)=>{
      if (!e.target.matches('.applied-toggle[data-job-id]')) return;
      const id = e.target.getAttribute("data-job-id");
      appliedById[id] = !!e.target.checked;
      scheduleSave();
    });
  }

  function setupAuthButtons(){
    $signinBtn.addEventListener("click", ()=>{
      const redirect = encodeURIComponent(window.location.href);
      window.location.href = `${API_BASE}/auth/start?redirect=${redirect}`;
    });
    $signoutBtn.addEventListener("click", ()=>{
      const redirect = encodeURIComponent(window.location.href);
      window.location.href = `${API_BASE}/auth/logout?redirect=${redirect}`;
    });
  }

  // ===== Init =====
  (async function init(){
    try{
      setupAuthButtons();
      wireCheckboxSaves();

      // load jobs.json
      const r = await fetch(JOBS_JSON_URL, { credentials: "omit" });
      if (!r.ok) throw new Error(`Failed to load jobs.json (${r.status})`);
      jobs = await r.json();

      await loadStatus();
      renderJobs();

      const loading = document.getElementById("loading"); if (loading) loading.remove();
    }catch(err){
      showError(err.message || String(err));
    }
  })();
  
  if ($signinBtn) {
    $signinBtn.addEventListener("click", () => {
      // make sure redirect ends with jobs.html (not jobs.htm)
      const fixed = window.location.href.replace(/jobs\.htm(\b|$)/, "jobs.html$1");
      const redirect = encodeURIComponent(fixed);
      window.location.href = `${API_BASE}/auth/start?redirect=${redirect}`;
    });
  }

  if ($signoutBtn) {
    $signoutBtn.addEventListener("click", () => {
      const fixed = window.location.href.replace(/jobs\.htm(\b|$)/, "jobs.html$1");
      const redirect = encodeURIComponent(fixed);
      window.location.href = `${API_BASE}/auth/logout?redirect=${redirect}`;
    });
  }
  
  </script>
</body>
</html>
