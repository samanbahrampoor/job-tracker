<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Jobs Dashboard (diagnostic)</title>
<style>
:root{--bg:#0f172a;--card:#0b1223;--muted:#94a3b8;--text:#e2e8f0;--accent:#60a5fa;--border:#1f2a44}
*{box-sizing:border-box}body{margin:0;background:#0f172a;color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
header{padding:20px 16px;text-align:center;border-bottom:1px solid var(--border);background:#0b1223;position:sticky;top:0}
.controls{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap;margin:10px auto}
select,input[type="search"]{background:#0a1120;border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px}
.container{max-width:1100px;margin:0 auto;padding:16px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
.card{background:#0b1223;border:1px solid var(--border);border-radius:12px;padding:14px}
.card a{color:var(--accent);text-decoration:none}
.meta{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
.notice{background:#0b1328;border:1px solid var(--border);padding:10px;border-radius:10px;margin:12px 0}
.badge{padding:4px 8px;border:1px solid var(--border);border-radius:999px;color:#cbd5e1}
#debug{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1328;border:1px solid var(--border);padding:10px;border-radius:10px;margin:10px 0;color:#93c5fd}
</style>
</head>
<body>
<header>
  <h1>Jobs Dashboard</h1>
  <div class="controls">
    <input id="q" type="search" placeholder="Search…">
    <select id="applied"><option value="all">All</option><option value="applied">Applied</option><option value="not_applied">Not applied</option></select>
    <select id="country"><option value="">All countries</option></select>
    <select id="city"><option value="">All cities</option></select>
    <span class="badge" id="count">0</span>
    <button id="loginBtn">Sign in with GitHub</button>
    <button id="logoutBtn" style="display:none">Sign out</button>
  </div>
</header>

<div class="container">
  <div id="debug" class="notice">Debug log:</div>
  <div id="signedOut" class="notice" style="display:none">Not signed in.</div>
  <div id="root"></div>
</div>

<script>
const WORKER_BASE = "https://job-tracker-oauth.saman-bahrampoor.workers.dev";
const APP_URL = "https://samanbahrampoor.github.io/job-tracker/jobs.html";
const dbg = (...a)=>{ const el=document.getElementById('debug'); el.textContent += '\\n' + a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' '); console.log(...a); };

function saveToken(tok){ sessionStorage.setItem("jobs_token", tok); }
function getToken(){ return sessionStorage.getItem("jobs_token"); }
function clearToken(){ sessionStorage.removeItem("jobs_token"); }

(function captureTokenFromHash(){
  const m = location.hash.match(/[#&]token=([^&]+)/);
  dbg('location.hash=', location.hash);
  if (m){
    const tok = decodeURIComponent(m[1]);
    saveToken(tok);
    dbg('captured token len=', tok.length);
    history.replaceState(null,"",location.pathname+location.search);
  } else {
    dbg('no token in hash');
  }
})();

let USER = null;
function storageKey(key){ return (USER ? ('applied::'+USER.login+'::') : 'applied::anon::') + key; }
function el(tag, cls, html){ const e=document.createElement(tag); if(cls) e.className=cls; if(html!==undefined) e.innerHTML=html; return e; }
function normalize(s){ return (s||'').toLowerCase(); }

function uniqueSorted(a){ return [...new Set(a.filter(Boolean))].sort((x,y)=>x.localeCompare(y)); }
function computeFilters(data){ const ctry=uniqueSorted(data.map(d=>d.country||d.Country)), city=uniqueSorted(data.map(d=>d.city||d.City));
  document.getElementById('country').innerHTML = '<option value=\"\">All countries</option>' + ctry.map(c=>`<option>${c}</option>`).join('');
  document.getElementById('city').innerHTML = '<option value=\"\">All cities</option>' + city.map(c=>`<option>${c}</option>`).join('');
}

function applyFilters(data){
  const q=normalize(document.getElementById('q').value);
  const filt=document.getElementById('applied').value;
  const country=document.getElementById('country').value;
  const city=document.getElementById('city').value;
  return data.filter(d=>{
    const title=d.title||d.Title, company=d.company||d.Company, cityv=d.city||d.City, countryv=d.country||d.Country, id=d.job_id||d.JobID||d.id;
    if(q && ![title,company,cityv,countryv,id].some(v=>normalize(String(v||'')).includes(q))) return false;
    if(country && countryv!==country) return false;
    if(city && cityv!==city) return false;
    const isApplied = localStorage.getItem(storageKey((company||'')+'|'+(id||'')))==='1';
    if(filt==='applied' && !isApplied) return false;
    if(filt==='not_applied' && isApplied) return false;
    return true;
  });
}

function render(data){
  const root=document.getElementById('root'); root.innerHTML='';
  let total=0;
  const byCompany = {};
  for (const d of data){
    const c = d.company||d.Company||'—';
    (byCompany[c]=byCompany[c]||[]).push(d);
  }
  Object.keys(byCompany).sort().forEach(company=>{
    root.appendChild(el('h2','',company));
    const grid=el('div','grid');
    for (const job of byCompany[company]){
      const title=job.title||job.Title||'Untitled';
      const url=job.url||job.Link||'#';
      const city=job.city||job.City||'';
      const country=job.country||job.Country||'';
      const id=job.job_id||job.JobID||job.id||'';
      const card=el('div','card');
      card.appendChild(el('div','', `<a href="${url}" target="_blank" rel="noopener">${title}</a>`));
      card.appendChild(el('div','meta', `<span>${city?city+', ':''}${country}</span> <span>ID: ${id}</span>`));
      grid.appendChild(card);
      total++;
    }
    root.appendChild(grid);
  });
  document.getElementById('count').textContent = total;
  dbg('render done, total=', total);
}

async function fetchJSON(path){
  const tok = getToken();
  const r = await fetch(path, { headers: tok ? { 'Authorization': 'Bearer '+tok } : {} });
  dbg('fetch', path, '→', r.status);
  if(!r.ok){ const t=await r.text(); dbg('response text:', t); throw new Error('HTTP '+r.status); }
  const j = await r.json();
  dbg('json length or keys:', Array.isArray(j)? j.length : Object.keys(j));
  return j;
}

async function refresh(){
  const tok = getToken(); dbg('stored token?', !!tok);
  if(!tok){
    document.getElementById('signedOut').style.display='block';
    document.getElementById('loginBtn').style.display='inline-block';
    document.getElementById('logoutBtn').style.display='none';
    return;
  }
  try{
    const session = await fetchJSON(WORKER_BASE+'/api/session');
    if(!session.authenticated){ dbg('not authenticated'); clearToken(); return refresh(); }
    USER = session.user; dbg('user=', USER);
    document.getElementById('signedOut').style.display='none';
    document.getElementById('loginBtn').style.display='none';
    document.getElementById('logoutBtn').style.display='inline-block';
    const data = await fetchJSON(WORKER_BASE+'/api/jobs');
    computeFilters(data);
    const run=()=>render(applyFilters(data));
    ['q','applied','country','city'].forEach(id=>{
      document.getElementById(id).addEventListener('input', run);
      document.getElementById(id).addEventListener('change', run);
    });
    run();
  }catch(e){
    dbg('refresh error', String(e));
    document.getElementById('signedOut').style.display='block';
  }
}

document.getElementById('loginBtn').addEventListener('click', ()=>{
  location.href = WORKER_BASE + '/oauth/login?redirect=' + encodeURIComponent(APP_URL);
});
document.getElementById('logoutBtn').addEventListener('click', ()=>{ clearToken(); location.reload(); });
document.addEventListener('DOMContentLoaded', refresh);
</script>
</body>
</html>