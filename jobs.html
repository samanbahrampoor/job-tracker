<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jobs Dashboard</title>
  <style>
    :root{--bg:#0f172a;--card:#0b1223;--muted:#94a3b8;--text:#e2e8f0;--accent:#60a5fa;--border:#1f2a44}
    body{background:var(--bg);color:var(--text);font-family:system-ui,sans-serif;margin:0;padding:2rem}
    h1{text-align:center;margin-bottom:1rem}
    .controls{display:flex;justify-content:center;gap:1rem;margin-bottom:1rem}
    .job{background:var(--card);padding:1rem;border-radius:.75rem;box-shadow:0 2px 6px rgba(0,0,0,.4);margin:.75rem 0}
    .company{font-weight:bold;margin-bottom:.25rem}
    .title{font-size:1.1rem;color:var(--accent);text-decoration:none}
    .title:hover{text-decoration:underline}
    .location{color:var(--muted);font-size:.9rem;margin:.25rem 0}
    .applied{display:flex;align-items:center;gap:.5rem;font-size:.85rem;color:var(--muted)}
    select,input[type=checkbox]{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:.25rem;padding:.25rem .5rem}
  </style>
</head>
<body>
  <h1>Jobs Dashboard</h1>
  <div class="controls">
    <label><input type="checkbox" id="filterApplied"> Show only applied</label>
    <select id="filterLocation"><option value="">All locations</option></select>
  </div>
  <div id="jobs"></div>
<script>
const WORKER_BASE = "https://job-tracker-oauth.saman-bahrampoor.workers.dev";
let token = null;

async function getSession() {
  if (!token) return null;
  const res = await fetch(WORKER_BASE + "/api/session", {
    headers: { Authorization: "Bearer " + token }
  });
  if (!res.ok) return null;
  return res.json();
}

async function getJobs() {
  const res = await fetch(WORKER_BASE + "/api/jobs", {
    headers: { Authorization: "Bearer " + token }
  });
  return res.json();
}

function renderJobs(jobs) {
  const container = document.getElementById("jobs");
  container.innerHTML = "";
  const filterApplied = document.getElementById("filterApplied").checked;
  const filterLoc = document.getElementById("filterLocation").value;
  for (const [company, postings] of Object.entries(jobs)) {
    const companyHeader = document.createElement("h2");
    companyHeader.textContent = company;
    container.appendChild(companyHeader);
    for (const job of postings) {
      if (filterApplied && !job.Applied) continue;
      if (filterLoc && job.Location !== filterLoc) continue;
      const div = document.createElement("div");
      div.className = "job";
      div.innerHTML = `
        <div class="company">${company}</div>
        <a class="title" href="${job.Link}" target="_blank">${job.Title}</a>
        <div class="location">${job.Location}</div>
        <label class="applied"><input type="checkbox" ${job.Applied ? "checked":""}> Applied</label>`;
      container.appendChild(div);
    }
  }
}

async function init() {
  token = new URLSearchParams(location.hash.slice(1)).get("token");
  if (!token) {
    const loginBtn = document.createElement("button");
    loginBtn.textContent = "Sign in with GitHub";
    loginBtn.onclick = () => { location = WORKER_BASE + "/oauth/login?redirect=" + encodeURIComponent(location.href); };
    document.body.prepend(loginBtn);
    return;
  }
  const session = await getSession();
  if (!session) { document.body.innerHTML="Login failed"; return; }
  const jobs = await getJobs();
  const locations = [...new Set(Object.values(jobs).flat().map(j=>j.Location))];
  const locSel = document.getElementById("filterLocation");
  for (const loc of locations) {
    const opt=document.createElement("option"); opt.value=loc; opt.textContent=loc; locSel.appendChild(opt);
  }
  document.getElementById("filterApplied").onchange=()=>renderJobs(jobs);
  document.getElementById("filterLocation").onchange=()=>renderJobs(jobs);
  renderJobs(jobs);
}
init();
</script>
</body>
</html>
