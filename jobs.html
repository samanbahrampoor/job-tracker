<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Job Tracker</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    h1 { font-size: 1.5rem; margin-bottom: 1rem; }
    .signin { margin-bottom: 1rem; }
    .job-group { margin-bottom: 2rem; }
    .job { border: 1px solid #ccc; border-radius: 8px; padding: 0.5rem; margin: 0.25rem 0; }
    .job-header { font-weight: bold; }
    .job small { color: #666; }
    label { display: flex; align-items: center; gap: 0.5rem; }
  </style>
</head>
<body>
  <h1>Job Tracker</h1>

  <div class="signin">
    <button id="signin">Sign in with GitHub</button>
    <span id="user-info"></span>
  </div>

  <div id="jobs"></div>

  <script>
    const WORKER_BASE = "https://<YOUR-WORKER-URL>"; // e.g. https://job-tracker.yourname.workers.dev
    let currentUser = null;
    let appliedMap = new Map();

    // Utility: create a stable job_id
    function jobId(job) {
      // Assume jobs.json has a unique "id" field, otherwise derive one
      return job.id || btoa(unescape(encodeURIComponent(job.company + "|" + job.title + "|" + job.city)));
    }

    // Fetch user info
    async function fetchUser() {
      const res = await fetch(`${WORKER_BASE}/api/me`, { credentials: "include" });
      if (res.ok) {
        const { user } = await res.json();
        currentUser = user;
        document.getElementById("user-info").textContent = `Signed in as ${user.email || user.id}`;
      } else {
        currentUser = null;
        document.getElementById("user-info").textContent = "Not signed in";
      }
    }

    // Fetch applied statuses
    async function fetchApplications() {
      if (!currentUser) return;
      const res = await fetch(`${WORKER_BASE}/api/applications`, { credentials: "include" });
      if (res.ok) {
        const { items } = await res.json();
        appliedMap = new Map(items.map(x => [x.job_id, !!x.applied]));
      }
    }

    // Toggle a job’s applied state
    async function setApplied(job_id, applied) {
      if (!currentUser) {
        alert("Please sign in first.");
        return;
      }
      await fetch(`${WORKER_BASE}/api/applications/${encodeURIComponent(job_id)}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ applied })
      });
    }

    // Render jobs grouped by company and location
    async function renderJobs() {
      const res = await fetch("jobs.json");
      const jobs = await res.json();

      const container = document.getElementById("jobs");
      container.innerHTML = "";

      // Group by company → location
      const groups = {};
      for (const job of jobs) {
        const cid = job.company || "Unknown Company";
        const loc = (job.country || "Unknown Country") + " / " + (job.city || "Unknown City");
        groups[cid] = groups[cid] || {};
        groups[cid][loc] = groups[cid][loc] || [];
        groups[cid][loc].push(job);
      }

      for (const [company, locs] of Object.entries(groups)) {
        const div = document.createElement("div");
        div.className = "job-group";
        const h2 = document.createElement("h2");
        h2.textContent = company;
        div.appendChild(h2);

        for (const [loc, jobsArr] of Object.entries(locs)) {
          const h3 = document.createElement("h3");
          h3.textContent = loc;
          div.appendChild(h3);

          for (const job of jobsArr) {
            const jid = jobId(job);
            const wrapper = document.createElement("div");
            wrapper.className = "job";

            const title = document.createElement("div");
            title.className = "job-header";
            title.textContent = job.title || "Untitled Job";

            const meta = document.createElement("small");
            meta.textContent = job.url ? job.url : "";

            const label = document.createElement("label");
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.checked = appliedMap.get(jid) || false;
            cb.addEventListener("change", () => setApplied(jid, cb.checked));
            label.appendChild(cb);
            label.appendChild(document.createTextNode("Applied"));

            wrapper.appendChild(title);
            if (job.url) {
              const a = document.createElement("a");
              a.href = job.url;
              a.target = "_blank";
              a.textContent = job.url;
              wrapper.appendChild(a);
            }
            wrapper.appendChild(meta);
            wrapper.appendChild(label);
            div.appendChild(wrapper);
          }
        }

        container.appendChild(div);
      }
    }

    // Init
    document.getElementById("signin").addEventListener("click", () => {
      window.location.href = `${WORKER_BASE}/auth/github/start`;
    });

    (async () => {
      await fetchUser();
      if (currentUser) {
        await fetchApplications();
      }
      await renderJobs();
    })();
  </script>
</body>
</html>
