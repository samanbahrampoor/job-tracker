<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Jobs Dashboard</title>
<style>
:root{--bg:#0f172a;--card:#0b1223;--muted:#94a3b8;--text:#e2e8f0;--accent:#60a5fa;--border:#1f2a44}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(135deg,#0b1020 0%,#0f172a 50%,#0a0f1f 100%);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(10,15,31,.7);border-bottom:1px solid var(--border)}
.header-inner{max-width:1100px;margin:0 auto;padding:16px;display:flex;flex-wrap:wrap;align-items:center;gap:12px}
h1{margin:0;font-size:22px;letter-spacing:.2px}.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-left:auto}
select,input[type="search"]{background:#0a1120;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;min-width:200px;outline:none}
input[type="search"]::placeholder{color:#7c8aa6}button{border:1px solid var(--border);background:#0b1328;color:#cbd5e1;padding:10px 12px;border-radius:12px;cursor:pointer}
button.primary{background:#1d4ed8;border-color:#1d4ed8;color:white}.badge{font-size:12px;padding:6px 10px;border-radius:999px;background:#0b1328;border:1px solid var(--border);color:#cbd5e1}
.container{max-width:1100px;margin:0 auto;padding:20px 16px 36px}.section{margin-top:18px}.section h2{margin:22px 0 6px;font-size:18px;font-weight:700;color:#c7d2fe}
.section h3{margin:12px 0 6px;font-size:14px;font-weight:700;color:#a5b4fc;opacity:.9}.section h4{margin:8px 0 10px;font-size:13px;font-weight:700;color:#93c5fd;opacity:.9}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}.card{background:linear-gradient(180deg,rgba(14,22,43,.9),rgba(12,17,33,.9));border:1px solid var(--border);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
.card a{color:var(--accent);text-decoration:none;font-weight:600}.meta{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}.tag{padding:2px 8px;border-radius:999px;background:#0d1731;border:1px solid var(--border)}
.toggle{display:inline-flex;align-items:center;gap:8px;user-select:none;cursor:pointer;width:fit-content}.toggle input{display:none}
.switch{width:40px;height:22px;border-radius:999px;background:#0f1a35;border:1px solid var(--border);position:relative;transition:.2s}.knob{position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#7c8aa6;transition:.2s}
input:checked + .switch{background:linear-gradient(90deg,#2563eb,#06b6d4);border-color:transparent}input:checked + .switch .knob{left:20px;background:white}
.apply-line{display:flex;align-items:center;justify-content:space-between;gap:10px}hr.sep{border:0;border-top:1px dashed var(--border);margin:12px 0 18px;opacity:.6}
.notice{background:#0b1328;border:1px solid var(--border);padding:14px;border-radius:12px}footer{text-align:center;color:#8aa0c6;padding:24px;border-top:1px solid var(--border);background:rgba(10,15,31,.4)}
</style>
</head>
<body>
<header><div class="header-inner"><h1>Jobs Dashboard</h1>
  <div class="controls">
    <input id="q" type="search" placeholder="Search title/company/city/country/id">
    <select id="appliedFilter"><option value="all">All</option><option value="applied">Applied</option><option value="not_applied">Not applied</option></select>
    <select id="countryFilter"><option value="">All countries</option></select>
    <select id="cityFilter"><option value="">All cities</option></select>
    <span class="badge" id="count"></span>
    <button id="loginBtn" class="primary">Sign in with GitHub</button>
    <button id="logoutBtn" style="display:none">Sign out</button>
  </div>
</div></header>
<main class="container">
  <div id="signedOut" class="notice" style="display:none"><strong>Private area.</strong> Please sign in with GitHub to view jobs.</div>
  <div id="root"></div>
</main>
<footer>Applied status is saved locally per user.</footer>
<script>
const WORKER_BASE = "https://job-tracker-oauth.saman-bahrampoor.workers.dev";
const APP_URL = "https://samanbahrampoor.github.io/job-tracker/jobs.html";

function saveToken(tok){ sessionStorage.setItem("jobs_token", tok); }
function getToken(){ return sessionStorage.getItem("jobs_token"); }
function clearToken(){ sessionStorage.removeItem("jobs_token"); }

(function captureTokenFromHash(){
  const m = location.hash.match(/[#&]token=([^&]+)/);
  if (m){ saveToken(decodeURIComponent(m[1])); history.replaceState(null,"",location.pathname+location.search); }
})();

let USER = null;
function storagePrefix(){ return USER ? ('applied::'+USER.login+'::') : 'applied::anon::'; }
function storageKey(key){ return storagePrefix() + key; }
function el(tag, cls, html){ const e=document.createElement(tag); if(cls) e.className=cls; if(html!==undefined) e.innerHTML=html; return e; }
function normalize(s){ return (s||'').toLowerCase(); }
function groupData(data){ const out={}; for (const r of data){const c=r.company||'—',co=r.country||'—',ci=r.city||'—'; (out[c]=out[c]||{}); (out[c][co]=out[c][co]||{}); (out[c][co][ci]=out[c][co][ci]||[]); out[c][co][ci].push(r);} return out; }
function uniqueSorted(a){ return [...new Set(a.filter(Boolean))].sort((x,y)=>x.localeCompare(y)); }
function computeFilters(data){ const ctry=uniqueSorted(data.map(d=>d.country)), city=uniqueSorted(data.map(d=>d.city));
  document.getElementById('countryFilter').innerHTML = '<option value="">All countries</option>' + ctry.map(c=>`<option>${c}</option>`).join('');
  document.getElementById('cityFilter').innerHTML = '<option value="">All cities</option>' + city.map(c=>`<option>${c}</option>`).join('');
}
function applyFilters(data){
  const q=normalize(document.getElementById('q').value);
  const applied=document.getElementById('appliedFilter').value;
  const country=document.getElementById('countryFilter').value;
  const city=document.getElementById('cityFilter').value;
  return data.filter(d=>{
    if(q){
      const hit=[d.title,d.company,d.city,d.country,d.job_id].some(v=>normalize(v).includes(q));
      if(!hit) return false;
    }
    if(country && d.country!==country) return false;
    if(city && d.city!==city) return false;
    const k=storageKey(d.key); const isApplied=localStorage.getItem(k)==='1';
    if(applied==='applied' && !isApplied) return false;
    if(applied==='not_applied' && isApplied) return false;
    return true;
  });
}
function render(data){
  const root=document.getElementById('root'); root.innerHTML=''; const grouped=groupData(data); let total=0;
  Object.keys(grouped).forEach(company=>{
    const section=el('section','section'); section.appendChild(el('h2','',company));
    Object.keys(grouped[company]).forEach(country=>{
      section.appendChild(el('h3','', 'Country: '+country));
      Object.keys(grouped[company][country]).forEach(city=>{
        section.appendChild(el('h4','', 'City: '+city)); const grid=el('div','grid'); const jobs=grouped[company][country][city];
        jobs.forEach(job=>{
          const card=el('div','card'); const title=el('div','', `<a href="${job.url}" target="_blank" rel="noopener">${job.title || 'Unknown Title'}</a>`);
          const meta=el('div','meta'); meta.appendChild(el('span','tag',job.company)); meta.appendChild(el('span','tag', job.city ? (job.city+', '+(job.country||'')) : (job.country||'Location: —'))); meta.appendChild(el('span','tag','ID: '+(job.job_id||'—')));
          const toggle=el('label','toggle apply-line'); const cb=el('input'); cb.type='checkbox'; const key=job.key||(job.company+'|'+job.job_id); cb.dataset.key=key; cb.checked=localStorage.getItem(storageKey(key))==='1';
          cb.addEventListener('change', ()=>{ if(cb.checked) localStorage.setItem(storageKey(key),'1'); else localStorage.removeItem(storageKey(key)); });
          const sw=el('span','switch'); const knob=el('span','knob'); sw.appendChild(knob); const lab=el('span','', 'Applied');
          toggle.appendChild(cb); toggle.appendChild(sw); toggle.appendChild(lab);
          card.appendChild(title); card.appendChild(meta); card.appendChild(toggle); grid.appendChild(card); total+=1; });
        section.appendChild(grid); section.appendChild(el('hr','sep')); }); });
    root.appendChild(section); });
  document.getElementById('count').textContent = total + ' roles';
}
async function fetchJSON(path){
  const token = getToken();
  const r = await fetch(path, { headers: token ? { 'Authorization': 'Bearer '+token } : {} });
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}
async function refresh(){
  const token = getToken();
  if(!token){
    document.getElementById('signedOut').style.display='block';
    document.getElementById('loginBtn').style.display='inline-block';
    document.getElementById('logoutBtn').style.display='none';
    document.getElementById('root').innerHTML='';
    document.getElementById('count').textContent='';
    return;
  }
  try{
    const session = await fetchJSON(WORKER_BASE+'/api/session');
    USER = session.authenticated ? session.user : null;
    if(!USER){ clearToken(); return refresh(); }
    document.getElementById('signedOut').style.display='none';
    document.getElementById('loginBtn').style.display='none';
    document.getElementById('logoutBtn').style.display='inline-block';
    const data = await fetchJSON(WORKER_BASE+'/api/jobs');
    computeFilters(data);
    const run=()=>render(applyFilters(data));
    ['q','appliedFilter','countryFilter','cityFilter'].forEach(id=>{
      document.getElementById(id).addEventListener('input', run);
      document.getElementById(id).addEventListener('change', run);
    });
    run();
  }catch(e){
    document.getElementById('signedOut').style.display='block';
    document.getElementById('root').innerHTML='<div class="notice">Failed to load jobs.</div>';
  }
}
document.getElementById('loginBtn').addEventListener('click', ()=>{
  location.href = WORKER_BASE + '/oauth/login?redirect=' + encodeURIComponent(APP_URL);
});
document.getElementById('logoutBtn').addEventListener('click', ()=>{ clearToken(); location.reload(); });
document.addEventListener('DOMContentLoaded', refresh);
</script>
</body>
</html>
